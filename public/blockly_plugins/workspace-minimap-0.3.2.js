/*! For license information please see index.js.LICENSE.txt */
!function(i,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("blockly/core"));else if("function"==typeof define&&define.amd)define(["blockly/core"],t);else{var e="object"==typeof exports?t(require("blockly/core")):t(i.Blockly);for(var s in e)("object"==typeof exports?exports:i)[s]=e[s]}}(this,(i=>(()=>{"use strict";var t={370:t=>{t.exports=i}},e={};function s(i){var o=e[i];if(void 0!==o)return o.exports;var r=e[i]={exports:{}};return t[i](r,r.exports,s),r.exports}s.d=(i,t)=>{for(var e in t)s.o(t,e)&&!s.o(i,e)&&Object.defineProperty(i,e,{enumerable:!0,get:t[e]})},s.o=(i,t)=>Object.prototype.hasOwnProperty.call(i,t),s.r=i=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})};var o={};s.r(o),s.d(o,{Minimap:()=>h,PositionedMinimap:()=>l});var r=s(370);const n=new Set([r.Events.VIEWPORT_CHANGE,r.Events.BLOCK_CHANGE,r.Events.BLOCK_CREATE,r.Events.BLOCK_DELETE,r.Events.BLOCK_DRAG,r.Events.BLOCK_MOVE]);class a{constructor(i,t){this.primaryWorkspace=i,this.minimapWorkspace=t,this.svgGroup=null,this.rect=null,this.background=null,this.initialized=!1,this.id=String(Math.random()).substring(2),this.onChangeWrapper=this.onChange.bind(this)}init(){this.svgGroup=r.utils.dom.createSvgElement(r.utils.Svg.G,{class:"blockly-focus-region"},null);const i=r.utils.dom.createSvgElement(new r.utils.Svg("mask"),{id:"focusRegionMask"+this.id},this.svgGroup);this.background=r.utils.dom.createSvgElement(r.utils.Svg.RECT,{x:0,y:0,width:"100%",height:"100%",mask:"url(#focusRegionMask"+this.id+")"},this.svgGroup),r.utils.dom.createSvgElement(r.utils.Svg.RECT,{x:0,y:0,width:"100%",height:"100%",fill:"white"},i),this.rect=r.utils.dom.createSvgElement(r.utils.Svg.RECT,{x:0,y:0,rx:6,ry:6,fill:"black"},i);const t=this.minimapWorkspace.getParentSvg();t.firstChild?t.insertBefore(this.svgGroup,t.firstChild):t.appendChild(this.svgGroup),window.addEventListener("resize",(()=>{this.update()})),window.addEventListener("load",(()=>{this.update()})),this.onChangeWrapper=this.onChange.bind(this),this.primaryWorkspace.addChangeListener(this.onChangeWrapper),this.update(),this.initialized=!0}dispose(){this.onChangeWrapper&&(this.primaryWorkspace.removeChangeListener(this.onChangeWrapper),this.onChangeWrapper=()=>null),this.svgGroup&&r.utils.dom.removeNode(this.svgGroup),this.svgGroup=null,this.rect=null,this.background=null,this.initialized=!1}onChange(i){n.has(i.type)&&this.update()}update(){const i=this.primaryWorkspace.getMetricsManager(),t=this.minimapWorkspace.getMetricsManager(),e=i.getViewMetrics(!0),s=i.getContentMetrics(!0),o=t.getContentMetrics(),r=t.getSvgMetrics();if(0===s.width)return;const n=o.width/t.getContentMetrics(!0).width,a=e.width*n,p=e.height*n;let h=(e.left-s.left)*n,l=(e.top-s.top)*n;if(h+=(r.width-o.width)/2,l+=(r.height-o.height)/2,!this.rect)throw new Error("The focus region must be initialized (`init`) before calling `update`");this.rect.setAttribute("transform",`translate(${h},${l})`),this.rect.setAttribute("width",a.toString()),this.rect.setAttribute("height",p.toString())}isEnabled(){return this.initialized}}r.Css.register("\n.blockly-focus-region {\n  fill: #e6e6e6;\n}\n");const p=new Set([r.Events.BLOCK_CHANGE,r.Events.BLOCK_CREATE,r.Events.BLOCK_DELETE,r.Events.BLOCK_DRAG,r.Events.BLOCK_MOVE]);class h{constructor(i){this.minimapWorkspace=null,this.focusRegion=null,this.onMouseMoveWrapper=null,this.onMouseDownWrapper=null,this.onMouseUpWrapper=null,this.minimapWrapper=null,this.primaryWorkspace=i}init(){var i;const t=this.primaryWorkspace.getInjectionDiv().parentNode;if(!t)throw new Error("The workspace must be injected into the page before the minimap can be initalized");this.minimapWrapper=document.createElement("div"),this.minimapWrapper.id="minimapWrapper"+this.primaryWorkspace.id,this.minimapWrapper.className="blockly-minimap",null==t||t.appendChild(this.minimapWrapper),this.minimapWorkspace=r.inject(this.minimapWrapper.id,{rtl:this.primaryWorkspace.RTL,move:{scrollbars:!0,drag:!1,wheel:!1},zoom:{maxScale:1/0,minScale:0},readOnly:!0,theme:this.primaryWorkspace.getTheme(),renderer:this.primaryWorkspace.options.renderer}),null===(i=this.minimapWorkspace.scrollbar)||void 0===i||i.setContainerVisible(!1),this.primaryWorkspace.addChangeListener((i=>{this.mirror(i)})),window.addEventListener("resize",(()=>{this.minimapWorkspace&&this.minimapWorkspace.zoomToFit()}));const e=i=>this.onClickDown(i);this.minimapWorkspace.svgGroup_.addEventListener("pointerdown",e,!0),this.onMouseDownWrapper=[[this.minimapWorkspace.svgGroup_,"pointerdown",e]],this.onMouseUpWrapper=r.browserEvents.bind(t,"mouseup",this,this.onClickUp),this.focusRegion=new a(this.primaryWorkspace,this.minimapWorkspace),this.enableFocusRegion()}dispose(){this.isFocusEnabled()&&this.disableFocusRegion(),this.minimapWorkspace&&this.minimapWorkspace.dispose(),r.utils.dom.removeNode(this.minimapWrapper),this.onMouseMoveWrapper&&r.browserEvents.unbind(this.onMouseMoveWrapper),this.onMouseDownWrapper&&r.browserEvents.unbind(this.onMouseDownWrapper),this.onMouseUpWrapper&&r.browserEvents.unbind(this.onMouseUpWrapper)}mirror(i){if(!p.has(i.type))return;if(i.type===r.Events.BLOCK_CREATE&&"shadow"===i.xml.tagName)return;const t=i.toJson();this.minimapWorkspace&&r.Events.fromJson(t,this.minimapWorkspace).run(!0),r.renderManagement.finishQueuedRenders().then((()=>{this.minimapWorkspace&&this.minimapWorkspace.zoomToFit()}))}static minimapToPrimaryCoords(i,t,e,s){e-=(t.svgWidth-t.contentWidth)/2,s-=(t.svgHeight-t.contentHeight)/2;const o=i.contentWidth/t.contentWidth;e*=o,s*=o;let r=-i.contentLeft-e,n=-i.contentTop-s;return r+=i.viewWidth/2,n+=i.viewHeight/2,[r,n]}primaryScroll(i){const t=this.primaryWorkspace.getMetrics();if(this.minimapWorkspace){const e=this.minimapWorkspace.getMetrics();if(t&&e){const[s,o]=h.minimapToPrimaryCoords(t,e,i.offsetX,i.offsetY);this.primaryWorkspace.scroll(s,o)}}}onClickDown(i){this.minimapWorkspace&&(i.stopImmediatePropagation(),this.onMouseMoveWrapper=r.browserEvents.bind(this.minimapWorkspace.svgGroup_,"mousemove",this,this.onMouseMove),this.primaryScroll(i))}onClickUp(){this.onMouseMoveWrapper&&(r.browserEvents.unbind(this.onMouseMoveWrapper),this.onMouseMoveWrapper=null)}onMouseMove(i){this.primaryScroll(i)}enableFocusRegion(){this.focusRegion&&this.focusRegion.init()}disableFocusRegion(){this.focusRegion&&this.focusRegion.dispose()}isFocusEnabled(){return!!this.focusRegion&&this.focusRegion.isEnabled()}}class l extends h{constructor(i){super(i),this.id="minimap",this.margin=20,this.top=0,this.left=0,this.width=225,this.height=150}init(){super.init(),this.primaryWorkspace.getComponentManager().addComponent({component:this,weight:3,capabilities:[r.ComponentManager.Capability.POSITIONABLE]}),this.primaryWorkspace.resize()}getBoundingRectangle(){return new r.utils.Rect(this.top,this.top+this.height,this.left,this.left+this.width)}position(i,t){this.setSize(),this.setPosition(i,t),this.setAttributes()}setSize(){const i=this.primaryWorkspace.getMetrics().viewWidth;this.width=Math.max(200,i/5),this.height=2*this.width/3}setPosition(i,t){const e=this.primaryWorkspace,s=e.scrollbar,o=s&&s.isVisible()&&s.canScrollVertically(),n=s&&s.isVisible()&&s.canScrollHorizontally();i.toolboxMetrics.position===r.TOOLBOX_AT_LEFT||e.horizontalLayout&&!e.RTL?(this.left=i.absoluteMetrics.left+i.viewMetrics.width-this.width-this.margin,o&&!e.RTL&&(this.left-=r.Scrollbar.scrollbarThickness)):(this.left=this.margin,o&&e.RTL&&(this.left+=r.Scrollbar.scrollbarThickness));const a=i.toolboxMetrics.position===r.TOOLBOX_AT_BOTTOM;a?(this.top=i.absoluteMetrics.top+i.viewMetrics.height-this.height-this.margin,n&&(this.top-=r.Scrollbar.scrollbarThickness)):this.top=i.absoluteMetrics.top+this.margin;let p=this.getBoundingRectangle();for(let i=0;i<t.length;i++)p.intersects(t[i])&&(this.top=a?t[i].top-this.height-this.margin:t[i].bottom+this.margin,p=this.getBoundingRectangle(),i=-1)}setAttributes(){var i;const t=null===(i=this.minimapWorkspace)||void 0===i?void 0:i.getInjectionDiv();if(!t)return;if(null===(null==t?void 0:t.parentElement))return;const e=t.parentElement.style;e.zIndex="2",e.position="absolute",e.width=`${this.width}px`,e.height=`${this.height}px`,e.top=`${this.top}px`,e.left=`${this.left}px`,this.minimapWorkspace&&r.svgResize(this.minimapWorkspace)}}return r.Css.register("\n.blockly-minimap {\n  box-shadow: 2px 2px 10px grey;\n}\n"),o})()));
//# sourceMappingURL=index.js.map